generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Supervisor {
  id        String             @id @default(cuid())
  name      String
  email     String?            @unique
  tier      String
  createdAt DateTime           @default(now())
  groups    Group[]
  sessions  Session[]
  reviews   SupervisorReview[]
}

model Fellow {
  id        String    @id @default(cuid())
  name      String
  createdAt DateTime  @default(now())
  groups    Group[]
  sessions  Session[]
}

model Group {
  id           String     @id @default(cuid())
  code         String     @unique
  fellowId     String
  supervisorId String
  createdAt    DateTime   @default(now())
  fellow       Fellow     @relation(fields: [fellowId], references: [id])
  supervisor   Supervisor @relation(fields: [supervisorId], references: [id])
  sessions     Session[]
}

model Session {
  id               String            @id @default(cuid())
  groupId          String
  fellowId         String
  supervisorId     String
  scheduledAt      DateTime
  completedAt      DateTime
  status           SessionStatus     @default(PENDING_ANALYSIS)
  transcript       String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  aiAnalysis       AIAnalysis?
  fellow           Fellow            @relation(fields: [fellowId], references: [id])
  group            Group             @relation(fields: [groupId], references: [id])
  supervisor       Supervisor        @relation(fields: [supervisorId], references: [id])
  supervisorReview SupervisorReview?
}

model AIAnalysis {
  id                       String   @id @default(cuid())
  sessionId                String   @unique
  summary                  String
  contentCoverageScore     Int
  contentCoverageRationale String
  facilitationScore        Int
  facilitationRationale    String
  protocolSafetyScore      Int
  protocolSafetyRationale  String
  riskFlag                 RiskFlag
  riskQuote                String?
  riskRationale            String
  rawModelResponse         Json?
  createdAt                DateTime @default(now())
  session                  Session  @relation(fields: [sessionId], references: [id])
}

model SupervisorReview {
  id           String         @id @default(cuid())
  sessionId    String         @unique
  supervisorId String
  finalStatus  FinalStatus
  decision     ReviewDecision
  note         String?
  createdAt    DateTime       @default(now())
  session      Session        @relation(fields: [sessionId], references: [id])
  supervisor   Supervisor     @relation(fields: [supervisorId], references: [id])
}

enum SessionStatus {
  PENDING_ANALYSIS
  PROCESSED
  FLAGGED_FOR_REVIEW
  SAFE
  RISK
  NEEDS_DISCUSSION
}

enum RiskFlag {
  SAFE
  RISK
}

enum ReviewDecision {
  VALIDATED
  OVERRIDDEN
}

enum FinalStatus {
  SAFE
  RISK
  NEEDS_DISCUSSION
}
